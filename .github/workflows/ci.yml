name: CI/CD Security Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install dependencies
      run: uv sync

    - name: Install Bandit & Safety
      run: pip install bandit safety
    
    - name: Run Bandit (SAST)
      run: |
        bandit -r app/ -f html -o bandit-report.html || true
        bandit -r app/ -f txt
    
    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.html
    
    - name: Run Safety (SCA)
      run: |
        safety scan --output html > safety-report.html || true
        safety scan
    
    - name: Upload Safety report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: safety-report
        path: safety-report.html
    
    - name: Run OWASP Dependency-Check (SCA)
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'itmo-cybersec-lab1'
        path: '.'
        format: 'HTML'
        out: 'reports'
        args: >
          --failOnCVSS 9
      continue-on-error: true
    
    - name: Upload OWASP Dependency-Check report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-report
        path: ${{github.workspace}}/reports

